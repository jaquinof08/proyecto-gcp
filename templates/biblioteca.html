{% extends "layout.html" %}
{% block title %}Biblioteca{% endblock %}

{# Hacemos el contenedor más ancho para la biblioteca #}
{% block container_class %}<div class="container container-wide">{% endblock %}

{% block content %}
    <h2><i class="fa fa-book-open"></i> Biblioteca de Contenidos</h2>
    <p style="text-align: center; margin-bottom: 30px;">Bienvenido, {{ current_user.nombre }}! Explora el material disponible.</p>
    
    {% for libro in libros %}
    <div class="libro-container" style="background-color: var(--surface-dark); padding: 25px; border-radius: 12px; margin-bottom: 40px; box-shadow: 0 4px 15px rgba(0,0,0,0.2);">
        <h3 style="color: var(--primary-accent); border-bottom: 2px solid var(--border-color); padding-bottom: 10px; margin-top: 0;">{{ libro.titulo }}</h3>
        <p>{{ libro.descripcion }}</p>
        
        <!-- Visor de PDF embebido -->
        <div class="pdf-viewer" style="border: 1px solid var(--border-color); border-radius: 10px; overflow: hidden; margin-top: 15px; min-height: 500px;">
            <embed src="/static/pdfs/{{ libro.archivo }}" type="application/pdf" width="100%" height="500px" />
        </div>
        <a href="/static/pdfs/{{ libro.archivo }}" download style="display: inline-block; margin-top: 15px; background-color: var(--primary-accent); color: #000; padding: 10px 20px; border-radius: 8px; font-weight: 700; text-decoration: none;"> <i class="fa fa-download"></i> Descargar PDF</a>
        
        <hr style="border: none; border-top: 1px solid var(--border-color); margin: 30px 0;">

        <h4><i class="fa fa-comments"></i> Comentarios</h4>
        <!-- Formulario para añadir un nuevo comentario -->
        <form action="{{ url_for('agregar_comentario') }}" method="post" style="margin-top: 15px;">
            <input type="hidden" name="nombre_libro" value="{{ libro.archivo }}">
            <textarea name="contenido" rows="3" placeholder="Escribe un comentario..." required></textarea>
            <button type="submit" style="width: auto; padding: 10px 20px; margin-top: 10px; font-size: 0.9em;">Comentar</button>
        </form>

        <!-- Lista de comentarios existentes -->
        <div style="margin-top: 20px;">
            {% for comentario in comentarios if comentario.book_filename == libro.archivo %}
                <div style="border-top: 1px solid var(--border-color); padding: 15px 0;">
                    <p><strong>{{ comentario.author.nombre }}:</strong> {{ comentario.content }}</p>
                    <small style="color: var(--text-secondary);">{{ comentario.timestamp.strftime('%d-%m-%Y %H:%M') }}</small>
                </div>
            {% else %}
                <p style="color: var(--text-secondary);">No hay comentarios para este libro. ¡Sé el primero!</p>
            {% endfor %}
        </div>
    </div>
    {% endfor %}
{% endblock %}
